<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaylorDash ‚Ä¢ Project Overview</title>
    <style>
      :root {
        --bg: #0b1220;
        --panel: #111a2b;
        --panel-2: #0e1726;
        --text: #e6edf3;
        --muted: #9fb0c3;
        --accent: #59b1ff;
        --accent-2: #7bffca;
        --code-bg: #0a1425;
        --ok: #34d399;
        --warn: #f59e0b;
        --err: #ef4444;
        --border: #1f2a44;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 20% 0%, rgba(89,177,255,0.08), transparent 60%),
                    radial-gradient(900px 500px at 80% 10%, rgba(123,255,202,0.08), transparent 60%),
                    var(--bg);
        color: var(--text);
        line-height: 1.6;
      }
      header {
        padding: 48px 24px 24px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(17,26,43,0.9), rgba(11,18,32,0.9));
        position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px);
      }
      .container { max-width: 1100px; margin: 0 auto; padding: 0 16px; }
      .title { font-size: 28px; font-weight: 800; letter-spacing: 0.2px; }
      .subtitle { color: var(--muted); margin-top: 6px; }
      .badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px; }
      .badge { border: 1px solid var(--border); color: var(--muted); padding: 4px 10px; border-radius: 999px; font-size: 12px; }
      main { padding: 28px 0 60px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 960px) { .grid { grid-template-columns: 280px 1fr; } }
      nav { position: sticky; top: 96px; align-self: start; }
      .toc { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
      .toc h3 { margin: 0 0 10px; font-size: 14px; color: var(--muted); }
      .toc a { display: block; color: var(--text); text-decoration: none; padding: 6px 8px; border-radius: 8px; font-size: 14px; }
      .toc a:hover { background: var(--panel-2); color: var(--accent); }
      section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px 20px; margin-bottom: 16px; }
      h2 { margin: 0 0 12px; font-size: 18px; letter-spacing: 0.3px; }
      .hint { color: var(--muted); font-size: 14px; margin-top: -6px; margin-bottom: 10px; }
      ul { margin: 10px 0 0 18px; }
      li { margin: 4px 0; }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      pre { background: var(--code-bg); padding: 12px; border-radius: 10px; overflow: auto; border: 1px solid var(--border); }
      .kv { display: grid; grid-template-columns: 180px 1fr; gap: 10px 18px; }
      .kv div { padding: 6px 0; border-bottom: 1px dashed var(--border); }
      .callouts { display: grid; grid-template-columns: 1fr; gap: 10px; }
      @media (min-width: 760px) { .callouts { grid-template-columns: repeat(3, 1fr); } }
      .card { background: var(--panel-2); border: 1px solid var(--border); padding: 14px; border-radius: 10px; }
      .pill { display: inline-block; padding: 2px 8px; font-size: 12px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted) }
      .ok { color: var(--ok); }
      .warn { color: var(--warn); }
      .err { color: var(--err); }
      a.inline { color: var(--accent); text-decoration: none; }
      a.inline:hover { text-decoration: underline; }
      footer { margin-top: 24px; color: var(--muted); font-size: 13px; }
      /* Tabs */
      .tabs { display: flex; gap: 10px; align-items: center; padding: 16px 0 0; }
      .tab-btn { background: var(--panel); border: 1px solid var(--border); color: var(--muted);
        padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
      .tab-btn:hover { color: var(--accent); background: var(--panel-2); }
      .tab-btn.active { color: var(--text); border-color: var(--accent); box-shadow: 0 0 0 1px rgba(89,177,255,0.3) inset; }
      .tab-content { display: none; }
      .tab-active { display: grid; }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="title">üåå TaylorDash ‚Ä¢ Project Overview</div>
        <div class="subtitle">Visual, add-only mission control ‚Äî React + FastAPI ¬∑ MQTT ¬∑ Prometheus</div>
        <div class="badges">
          <span class="badge">Status: alpha</span>
          <span class="badge">Frontend: React/Vite</span>
          <span class="badge">Backend: FastAPI</span>
          <span class="badge">Infra: Docker Compose</span>
          <span class="badge">Observability: OTel + Prometheus</span>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="log">Knowledge Log</button>
      </div>
    </div>

    <main id="tab-overview" class="container grid tab-content tab-active">
      <nav>
        <div class="toc">
          <h3>Contents</h3>
          <a href="#overview">Overview</a>
          <a href="#architecture">Architecture</a>
          <a href="#backend">Backend</a>
          <a href="#frontend">Frontend</a>
          <a href="#infrastructure">Infrastructure</a>
          <a href="#auth">Auth Model</a>
          <a href="#endpoints">Key Endpoints</a>
          <a href="#run">Run & Access</a>
          <a href="#security">Security Posture</a>
          <a href="#gaps">Gaps & To‚ÄëDos</a>
          <a href="#next">Suggested Next Steps</a>
        </div>
      </nav>

      <div>
        <section id="overview">
          <h2>Overview</h2>
          <p>Visual project command center with add-only architecture. Draggable UI plugins, event-driven backend, and strong observability. Runs locally via Docker Compose.</p>
          <div class="kv" style="margin-top:10px">
            <div><strong>Core</strong></div><div>React (Vite, Tailwind) ‚Ä¢ FastAPI ‚Ä¢ MQTT</div>
            <div><strong>Storage</strong></div><div>Postgres (metadata) ‚Ä¢ VictoriaMetrics (TSDB) ‚Ä¢ MinIO (objects)</div>
            <div><strong>Edge</strong></div><div>Traefik (TLS/HSTS) ‚Ä¢ Prometheus ‚Ä¢ Grafana</div>
            <div><strong>Plugins</strong></div><div>Secured install/list/update ‚Ä¢ Registry synced to frontend</div>
          </div>
        </section>

        <section id="architecture">
          <h2>Architecture</h2>
          <div class="callouts">
            <div class="card"><strong>Add‚ÄëOnly</strong><br />Evolve by adding adapters/plugins without core rewrites.</div>
            <div class="card"><strong>Event‚ÄëDriven</strong><br />MQTT at the center, with DLQ and DB mirror for reliability.</div>
            <div class="card"><strong>Observable</strong><br />OpenTelemetry traces/metrics; Prometheus scrapes /metrics.</div>
          </div>
          <p class="hint">Docs in: <code>README.md</code>, <code>infra/README*.md</code>, backend/frontend READMEs.</p>
        </section>

        <section id="backend">
          <h2>Backend (FastAPI)</h2>
          <ul>
            <li><strong>Entry</strong>: <code>backend/app/main.py</code> with lifespan, CORS, security headers, metrics, OTel.</li>
            <li><strong>Routers</strong>: <code>auth.py</code> (session login, admin/viewer) ‚Ä¢ <code>plugins.py</code> (install/list/update/uninstall/config/health/stats/scan) ‚Ä¢ <code>mcp.py</code> (admin‚Äëgated subprocess manager).</li>
            <li><strong>Security</strong>: <code>X-API-Key</code> required for <code>/api/v1/*</code>; standard security headers.</li>
            <li><strong>DB</strong>: <code>asyncpg</code> pool; migrations on startup; seed <code>admin/admin123</code>.</li>
            <li><strong>MQTT</strong>: Reconnect, backoff, DLQ, Postgres mirror; labeled metrics.</li>
            <li><strong>Plugins</strong>: Pydantic manifest validation, installer, security validator.</li>
          </ul>
        </section>

        <section id="frontend">
          <h2>Frontend (React)</h2>
          <ul>
            <li><strong>Routing & UI</strong>: Dashboard, Projects, Flow Canvas, Settings, Plugins (iframe/sandboxed).</li>
            <li><strong>Auth</strong>: Context manages session token + expiry warnings; <code>ProtectedRoute</code> handles admin/viewer.</li>
            <li><strong>Services</strong>: Axios client under <code>/api</code> adds <code>X-API-Key</code>; MQTT service for realtime.</li>
            <li><strong>Plugins</strong>: <code>src/plugins/registry.ts</code> auto‚Äëupdated entries (e.g., Midnight HUD, MCP Manager).</li>
          </ul>
        </section>

        <section id="infrastructure">
          <h2>Infrastructure (Docker Compose)</h2>
          <ul>
            <li><strong>Core</strong>: Traefik, Postgres, Mosquitto, VictoriaMetrics, MinIO, Prometheus, Grafana, Backend.</li>
            <li><strong>Access</strong>: Backend routed by Traefik on host <code>taylordash.local</code> (see labels).</li>
            <li><strong>Dev</strong>: Frontend via Vite proxy; production static host can be added via Traefik.</li>
          </ul>
        </section>

        <section id="auth">
          <h2>Auth Model</h2>
          <ul>
            <li><strong>Actual</strong>: API‚Äëkey + session tokens (DB‚Äëbacked) with admin/viewer roles.</li>
            <li><strong>Docs (Roadmap)</strong>: OIDC/Keycloak + JWT are referenced but not wired yet.</li>
          </ul>
        </section>

        <section id="endpoints">
          <h2>Key Endpoints</h2>
          <pre><code>GET  /health/live, /health/ready, /metrics, /api/v1/health/stack
POST /api/v1/auth/login,  GET /api/v1/auth/me,   POST /api/v1/auth/logout,  (admin) /api/v1/auth/users*
CRUD /api/v1/projects*,   /api/v1/components*,   /api/v1/events*,           /api/v1/dlq
Plugins: /api/v1/plugins/*  (install/list/update/uninstall/config/health/stats/scan/registry)
MCP:     /mcp/*  (servers, connect, request, metrics, health, disconnect; admin‚Äëonly)</code></pre>
        </section>

        <section id="run">
          <h2>Run & Access</h2>
          <p>Minimal dev run (DB + MQTT + Backend):</p>
          <pre><code>docker compose up -d postgres mosquitto backend</code></pre>
          <p>Frontend (dev):</p>
          <pre><code>cd frontend
npm i
npm run dev</code></pre>
          <p>Default admin: <code>admin / admin123</code></p>
        </section>

        <section id="security">
          <h2>Security Posture</h2>
          <ul>
            <li><span class="ok">‚úî</span> API‚Äëkey on <code>/api/v1/*</code>, bcrypt, audit logs, headers, plugin validation path.</li>
            <li><span class="ok">‚úî</span> MQTT DLQ + DB mirror, parameterized queries, Prometheus metrics.</li>
            <li><span class="warn">‚ñ≥</span> OIDC/Keycloak not yet integrated; CSP/HSTS via Traefik config TBD.</li>
          </ul>
        </section>

        <section id="gaps">
          <h2>Gaps & To‚ÄëDos</h2>
          <ul>
            <li>Align docs vs implementation (OIDC vs session tokens + API‚Äëkey).</li>
            <li>Add global axios interceptor for Bearer token (frontend consistency).</li>
            <li>Package a static frontend for production (Traefik route or nginx).</li>
            <li>Parameterize MCP server commands via env/config.</li>
          </ul>
        </section>

        <section id="next">
          <h2>Suggested Next Steps</h2>
          <ol>
            <li>Decide on auth: wire Keycloak or document session‚Äëtoken model as v1.</li>
            <li>Add CSP/HSTS in Traefik and verify headers.</li>
            <li>Introduce a prod frontend container or Traefik‚Äëserved static site.</li>
            <li>Harden plugin validator with more runtime checks and schemas.</li>
          </ol>
          <footer>
            Generated overview ‚Ä¢ overview_export/index.html
          </footer>
        </section>
      </div>
    </main>

    <!-- Knowledge Log Tab -->
    <main id="tab-log" class="container grid tab-content">
      <div>
        <section>
          <h2>Knowledge Log</h2>
          <p class="hint">Chronological, append‚Äëonly replies. Latest on top.</p>
          <div id="knowledge-log">
            <!-- ENTRY: 2025-09-13  -->
            <article style="margin: 8px 0 18px; padding:12px; border:1px solid var(--border); border-radius:12px; background: var(--panel);">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>Setup</strong>
                <span class="pill">2025-09-13</span>
              </div>
              <p style="margin: 8px 0 0; color: var(--muted);">
                Initialized the Knowledge Log tab. Future assistant replies will be appended here as new entries so you can keep a running view without juggling files. If you want per‚Äëentry anchors or tags, say the word and I‚Äôll add them.
              </p>
            </article>
            <!-- ENTRY: 2025-09-13 -->
            <article style="margin: 8px 0 18px; padding:14px; border:1px solid var(--border); border-radius:12px; background: var(--panel);">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                <strong>Full Project Debrief</strong>
                <span class="pill">2025-09-13</span>
              </div>

              <h3 style="margin:12px 0 6px;">Overview</h3>
              <p>Visual, add-only ‚Äúmission control‚Äù for projects with a React frontend, FastAPI backend, plugin system, and MQTT-driven events. Local-first via Docker Compose; strong observability and security guardrails.</p>

              <h3 style="margin:12px 0 6px;">Top-Level Structure</h3>
              <ul>
                <li><strong>Backend</strong>: FastAPI app (<code>backend/app</code>), routers/services/models/db/mqtt/security; tests; Dockerfile; pyproject.</li>
                <li><strong>Frontend</strong>: React/Vite app (<code>frontend/</code>) with plugin UI, Auth context, services.</li>
                <li><strong>Infra</strong>: <code>docker-compose.yml</code>, <code>infra/</code> (Traefik, Prometheus, Grafana, Mosquitto, Postgres, MinIO, Timescale).</li>
                <li><strong>Ops</strong>: <code>ops/</code> scripts (backup, validation, release).</li>
                <li><strong>Docs</strong>: Di√°taxis-style docs and multiple audit/test reports.</li>
                <li><strong>Examples</strong>: UI plugin examples (Midnight HUD, MCP Manager).</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Backend (FastAPI)</h3>
              <ul>
                <li><strong>Entry</strong>: <code>app/main.py</code> with lifespan startup, CORS, security headers, Prometheus metrics, OTel, plugin DB init, MQTT wiring.</li>
                <li><strong>Routers</strong>:
                  <ul>
                    <li><code>auth.py</code>: Session login/logout; admin/viewer roles; remember me; <code>/api/v1/auth/*</code>.</li>
                    <li><code>plugins.py</code>: Install/list/update/uninstall/config/health/stats/security scan; API-key protection.</li>
                    <li><code>mcp.py</code>: Admin-gated MCP subprocess manager with cleanup and timeouts.</li>
                  </ul>
                </li>
                <li><strong>Security</strong>: <code>X-API-Key</code> enforced for <code>/api/v1/*</code>; public paths whitelisted; security headers middleware.</li>
                <li><strong>Data layer</strong>: <code>database.py</code> asyncpg pool, migrations at init, seeds default admin <code>admin/admin123</code>.</li>
                <li><strong>MQTT</strong>: <code>mqtt_client.py</code> reconnect, DLQ, Postgres mirror, metrics, tracing.</li>
                <li><strong>Plugins</strong>: <code>models/plugin.py</code> (manifests, enums); services for install + security validation.</li>
                <li><strong>Deps</strong>: Managed via <code>pyproject.toml</code> (FastAPI, asyncpg, aiomqtt, OTel, Prometheus, bcrypt).</li>
                <li><strong>Tests</strong>: <code>backend/tests/test_plugin_security.py</code> async fixtures/mocks and static analyses.</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Frontend (React/Vite/TS)</h3>
              <ul>
                <li><strong>App</strong>: Routes (dashboard, projects, flow canvas, settings, plugins), nav, error boundaries.</li>
                <li><strong>Auth</strong>: <code>AuthContext</code> with session token + expiry timers; <code>ProtectedRoute</code> enforces roles.</li>
                <li><strong>Services</strong>: <code>services/api.ts</code> (axios under <code>/api</code> with <code>X-API-Key</code>), MQTT and internal event bus.</li>
                <li><strong>Plugin UI</strong>: <code>src/plugins/registry.ts</code> lists installed UI plugins (Midnight HUD, MCP Manager, Projects Manager).</li>
                <li><strong>Dev config</strong>: <code>vite.config.ts</code> proxies <code>/api</code> to <code>http://localhost</code> with Host header.</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Infrastructure</h3>
              <ul>
                <li><strong>Compose services</strong>: Traefik, Postgres, Mosquitto, VictoriaMetrics, MinIO, Prometheus, Grafana, Backend.</li>
                <li><strong>Routing</strong>: Traefik labels route <code>/api</code> to backend on host <code>taylordash.local</code>.</li>
                <li><strong>Dev vs Prod</strong>: Frontend via Vite in dev; prod needs static host or Traefik-served assets.</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Ops &amp; Validation</h3>
              <ul>
                <li><code>ops/validate_p1.sh</code>: Health, RBAC 401s, /metrics, MQTT echo, plugin smoke.</li>
                <li>Backups: <code>backup_db.sh</code>, <code>backup_git.sh</code>, <code>backup_vm.sh</code>.</li>
                <li>Audit: <code>audit_repo.sh</code>, plugin security validation.</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Docs &amp; Reports</h3>
              <ul>
                <li>Root: <code>README.md</code>, <code>SECURITY.md</code>, <code>INTEGRATION_MAP.md</code>, <code>COMMON_TASKS.md</code>, <code>TROUBLESHOOTING_MATRIX.md</code>.</li>
                <li>App READMEs &amp; QUICK_REFERENCE in backend/frontend.</li>
                <li>Reports: Comprehensive system/UI/auth audits, API contract validation, UI test screenshots.</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Authentication Model</h3>
              <ul>
                <li><strong>Actual</strong>: API key header + DB-backed session tokens; admin/viewer roles; auth router.</li>
                <li><strong>Docs</strong>: Mention OIDC/Keycloak + JWT ‚Äî roadmap, not wired yet.</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Key Endpoints</h3>
              <pre><code>Health/Metrics:  GET /health/live  /health/ready  /api/v1/health/stack  /metrics
Auth:            POST /api/v1/auth/login  GET /api/v1/auth/me  POST /api/v1/auth/logout  (admin) /api/v1/auth/users*
Projects:        /api/v1/projects*  /api/v1/components*  /api/v1/events*  /api/v1/dlq
Plugins:         /api/v1/plugins/*  (install/list/update/uninstall/config/health/stats/scan/registry)
MCP:             /mcp/* (servers, connect, request, metrics, health, disconnect; admin-only)</code></pre>

              <h3 style="margin:12px 0 6px;">How To Run (dev)</h3>
              <pre><code># Backend + deps via Compose
docker compose up -d postgres mosquitto backend

# Frontend (dev)
cd frontend
npm i
npm run dev

# Default admin
admin / admin123</code></pre>

              <h3 style="margin:12px 0 6px;">Security Posture</h3>
              <ul>
                <li><span class="ok">‚úî</span> API-key enforcement, bcrypt, audit logs, security headers, plugin validation path.</li>
                <li><span class="ok">‚úî</span> MQTT DLQ + DB mirror, parameterized queries, Prometheus/OTel.</li>
                <li><span class="warn">‚ñ≥</span> OIDC/Keycloak and CSP/HSTS via Traefik not fully wired.</li>
              </ul>

              <h3 style="margin:12px 0 6px;">Notable Inconsistencies / To‚ÄëDos</h3>
              <ul>
                <li>Docs reference OIDC/Keycloak; code uses API-key + sessions ‚Äî decide and align.</li>
                <li>Axios doesn‚Äôt always attach Bearer token; add global interceptor.</li>
                <li>Compose lacks a prod frontend container; add nginx or Traefik static service.</li>
                <li>MCP server commands use local absolute paths; parameterize via env/config.</li>
                <li>Unify dependency management (prefer <code>pyproject.toml</code> over scattered reqs).</li>
              </ul>
            </article>
            <!-- KNOWLEDGE_LOG_INSERT -->
          </div>
        </section>
      </div>
    </main>

    <script>
      (function(){
        const buttons = document.querySelectorAll('.tab-btn');
        const overview = document.getElementById('tab-overview');
        const log = document.getElementById('tab-log');
        function activate(name){
          buttons.forEach(b => b.classList.toggle('active', b.dataset.tab === name));
          if(name === 'overview'){
            overview.classList.add('tab-active');
            log.classList.remove('tab-active');
          } else {
            log.classList.add('tab-active');
            overview.classList.remove('tab-active');
          }
        }
        buttons.forEach(b => b.addEventListener('click', () => activate(b.dataset.tab)));
      })();
    </script>
  </body>
</html>
